{{- $view := or .design.view "custom_view_a" -}}
{{- $tpl  := printf "views/%s.html" $view -}}

{{- $lang := site.Language.Lang -}}
{{- with .Page }}{{- $lang = .Language.Lang -}}{{- end -}}

{{- /* 1. 모든 정규 페이지 가져오기 */ -}}
{{- $all := where site.RegularPages "Lang" $lang -}}
{{- $all = where $all "Draft" "!=" true -}}

{{- /* 2. .content.filters.folders 값을 가져옴 (없으면 빈 슬라이스) */ -}}
{{- $folders := .content.filters.folders | default (slice) -}}

{{- /* 3. $pages 변수를 선언 */ -}}
{{- $pages := slice -}}

{{- /* 4. $folders 목록의 길이가 0보다 큰지 (필터가 설정되었는지) 확인 */ -}}
{{- if gt (len $folders) 0 -}}
  {{- /* 4a. 필터가 있으면: $all(모든 페이지)에서 Section이 일치하는 페이지만 $pages에 추가 */ -}}
  {{- range $folder := $folders -}}
    {{- $folderPages := where $all "Section" $folder -}}
    {{- $pages = $pages | append $folderPages -}}
  {{- end -}}
{{- else -}}
  {{- /* 4b. 필터가 없으면: $pages는 $all (모든 페이지)가 됨 */ -}}
  {{- $pages = $all -}}
{{- end -}}

{{- /* --- 나머지 필터들은 위에서 정제된 $pages를 기준으로 적용 --- */ -}}

{{- /* kind 필터 (있는 경우) */ -}}
{{- with .content.filters.kind -}}
  {{- $pages = where $pages "Kind" . -}}
{{- end -}}

{{- /* exclude_featured 필터 (있는 경우) */ -}}
{{- with .content.filters.exclude_featured -}}
  {{- if eq . true -}}
    {{- $pages = where $pages "Params.featured" "!=" true -}}
  {{- end -}}
{{- end -}}

{{- /* tag 필터 (있는 경우) */ -}}
{{- with .content.filters.tag -}}
  {{- $pages = where $pages "Params.tags" "intersect" (slice .) -}}
{{- end -}}

{{- /* 날짜순 정렬 */ -}}
{{- $pages = sort $pages "Date" "desc" -}}

{{- /* 개수 제한 */ -}}
{{- $n := or .content.count 9 -}}
{{- $pages = first $n $pages -}}

{{- /* 각 페이지를 해당 뷰 템플릿으로 렌더링 */ -}}
{{- range $pages -}}
  {{ partial $tpl (dict "page" .) }}
{{- end -}}